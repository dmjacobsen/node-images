---

- name: copy sysstat service into place
  copy:
    remote_src: yes
    src: /srv/cray/resources/metal/sysstat.cron
    dest: /etc/sysstat/sysstat.cron
  register: copy_sysstat_service

- name: disk system activity accounting
  command: "/usr/lib64/sa/sa1 -S DISK 1 1"
  when: copy_sysstat_service.changed

- name: enable sysstat service
  systemd:
    name: "{{ item }}"
    enabled: yes
    masked: no
  with_items:
    - sysstat.service

- name: copy mdadm.conf into place
  copy:
    remote_src: yes
    src: /srv/cray/resources/metal/mdadm.conf
    dest: /etc/mdadm.conf

# Agentless Management Service only works on servers with iLO4/5.
# Disable by default, enable during runtime.
- name: disable Agentless Management Daemon
  systemd:
    name: "{{ item }}"
    enabled: no
    state: stopped
  with_items:
    - ahslog
    - amsd
    - cpqFca
    - cpqIde
    - cpqScsi
    - smad

- name: configure dhcp settings
  lineinfile:
    path: /etc/sysconfig/network/dhcp
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - {regexp: '^DHCLIENT_FQDN_ENABLED=', line: 'DHCLIENT_FQDN_ENABLED="enabled"'}
    - {regexp: '^DHCLIENT_FQDN_UPDATE=', line: 'DHCLIENT_FQDN_UPDATE="both"'}
    - {regexp: '^DHCLIENT_SET_HOSTNAME=', line: 'DHCLIENT_SET_HOSTNAME="no"'}
